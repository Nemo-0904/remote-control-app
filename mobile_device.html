<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mobile Device</title>
    <link rel="stylesheet" href="device.css" />
    <style>
      /* Hide local video preview */
      #localVideo {
        display: none;
        width: 1px;
        height: 1px;
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <!-- âœ… Navbar using custom CSS classes -->
    <nav class="navbar">
      <div class="navbar-brand">Remote Pilot</div>
      <div class="navbar-links">
        <a href="controller_panel.html">Control Panel</a>
        <a href="mobile" class="active">Mobile Device</a>
      </div>
    </nav>

    <!-- Game grid -->
    <div id="game-area">
      <div id="character"></div>
    </div>

    <!-- Hidden video stream -->
    <video id="localVideo" autoplay playsinline></video>

    <!-- Camera status indicator -->
    <div
      id="cameraStatus"
      style="
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        z-index: 100;
      "
    >
      Camera: Inactive
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      const socket = io("https://remote-control-app-b072.onrender.com");
      const character = document.getElementById("character");
      const localVideo = document.getElementById("localVideo");
      const cameraStatusElement = document.getElementById("cameraStatus");

      const CANVAS_WIDTH = 320;
      const CANVAS_HEIGHT = 240;
      const GRID_SIZE = 30;
      const GAME_AREA_DIM = 300;
      const CHAR_DIM = 30;

      let currentPosX = 135;
      let currentPosY = 135;
      character.style.left = `${currentPosX}px`;
      character.style.top = `${currentPosY}px`;

      let mediaStream = null;
      let cameraInterval = null;

      function updateCharacterPosition(x, y) {
        currentPosX = x;
        currentPosY = y;
        character.style.left = `${x}px`;
        character.style.top = `${y}px`;
      }

      async function startCamera() {
        if (mediaStream) {
          console.log("Camera already active.");
          updateCameraStatus("Active");
          return;
        }
        try {
          updateCameraStatus("Starting...");
          mediaStream = await navigator.mediaDevices.getUserMedia({
            video: { width: CANVAS_WIDTH, height: CANVAS_HEIGHT },
            audio: false,
          });
          localVideo.srcObject = mediaStream;
          await localVideo.play();

          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.width = CANVAS_WIDTH;
          canvas.height = CANVAS_HEIGHT;

          function captureAndSendFrame() {
            if (localVideo.readyState === localVideo.HAVE_ENOUGH_DATA) {
              context.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
              const dataURL = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];
              socket.emit("mobile_camera_frame", { frame: dataURL });
            }
          }

          cameraInterval = setInterval(captureAndSendFrame, 100);
          updateCameraStatus("Active");
          console.log("Mobile camera started and sending frames.");
        } catch (err) {
          console.error("Error accessing camera:", err);
          updateCameraStatus(`Error: ${err.name}`);
          alert(`Could not start camera: ${err.message}`);
          stopCamera();
        }
      }

      function stopCamera() {
        if (cameraInterval) {
          clearInterval(cameraInterval);
          cameraInterval = null;
        }
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }
        localVideo.srcObject = null;
        updateCameraStatus("Inactive");
        console.log("Mobile camera stopped.");
      }

      function updateCameraStatus(status) {
        cameraStatusElement.textContent = `Camera: ${status}`;
      }

      socket.on("connect", () => {
        console.log("Mobile device connected to server.");
      });

      socket.on("disconnect", () => {
        console.log("Mobile device disconnected from server.");
        stopCamera();
      });

      socket.on("character_position_update", (position) => {
        updateCharacterPosition(position.x, position.y);
      });

      socket.on("start_camera_stream", () => {
        console.log("Received command to start camera stream.");
        startCamera();
      });

      socket.on("stop_camera_stream", () => {
        console.log("Received command to stop camera stream.");
        stopCamera();
      });

      window.onload = () => {
        console.log("Mobile device page loaded.");
      };
    </script>
  </body>
</html>
